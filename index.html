<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>見積もり作成フォーム</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // クエリパラメータがなければ追加してリダイレクト
        if (!window.location.search) {
            window.location.href = window.location.href + "?v=19";
        }
    </script>
    <style>
        body { font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; margin: 0; padding: 16px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #06c755; margin-bottom: 25px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input[type="text"], input[type="date"], input[type="number"], input[type="tel"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; appearance: none; }
        input[type="number"] { text-align: right; }
        textarea { height: 80px; resize: vertical; }
        button { background-color: #06c755; color: white; border: none; border-radius: 4px; padding: 12px 20px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; display: block; margin: 20px auto 0; width: 100%; max-width: 300px; }
        button:hover { background-color: #05a544; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #itemsTable { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        #itemsTable th, #itemsTable td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; word-wrap: break-word; }
        #itemsTable th { background-color: #f2f2f2; font-weight: bold; }
        #itemsTable th:nth-child(1) { width: 35%; }
        #itemsTable th:nth-child(2) { width: 15%; }
        #itemsTable th:nth-child(3) { width: 20%; }
        #itemsTable th:nth-child(4) { width: 20%; }
        #itemsTable th:nth-child(5) { width: 10%; }
        #itemsTable input[type="text"], #itemsTable input[type="number"] { width: 95%; padding: 6px; font-size: 14px; -webkit-appearance: none; appearance: none; }
        #itemsTable .item-subtotal { text-align: right; min-width: auto; }
        #itemsTable .action-cell { width: auto; text-align: center; }
        .remove-item-btn { background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 8px; font-size: 12px; cursor: pointer; }
        .add-item-btn { background-color: #007bff; color: white; border: none; border-radius: 4px; padding: 8px 15px; font-size: 14px; cursor: pointer; margin-top: 10px; }
        .total-section { margin-top: 20px; text-align: right; font-size: 16px; font-weight: bold; }
        .total-section div { margin-bottom: 5px; }
        .total-section span { display: inline-block; min-width: 100px; text-align: right; margin-left: 10px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.2em; z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        #loadingOverlay.show { visibility: visible; opacity: 1; }
        #errorMessage { color: #dc3545; margin-top: 15px; text-align: center; font-weight: bold; min-height: 1.2em; }
        small { font-size: 0.8em; color: #6c757d; }
        .required-mark { color: red; margin-left: 2px; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        @media (max-width: 600px) {
            .form-row { flex-direction: column; gap: 0; }
        }
        .current-date { font-size: 14px; text-align: right; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>見積もり作成</h1>
        <div class="current-date">作成日: <span id="todayDate"></span></div>
        <form id="quoteForm">
            <input type="hidden" name="formType" value="quote">
            <input type="hidden" name="createdDate" id="createdDateInput">
            <input type="hidden" name="taxRate" value="10">

            <div class="form-row">
                <div class="form-group">
                    <label for="customerName">顧客名<span class="required-mark">*</span></label>
                    <input type="text" id="customerName" name="customerName" required>
                </div>
                <div class="form-group">
                    <label for="subject">件名<span class="required-mark">*</span></label>
                    <input type="text" id="subject" name="subject" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="staffName">担当者氏名<span class="required-mark">*</span></label>
                    <input type="text" id="staffName" name="staffName" required>
                </div>
                <div class="form-group">
                    <label for="staffPhone">担当者電話番号<span class="required-mark">*</span></label>
                    <input type="tel" id="staffPhone" name="staffPhone" required pattern="[0-9\-]*">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="projectNumber">案件番号<span class="required-mark">*</span></label>
                    <input type="text" id="projectNumber" name="projectNumber" required>
                    <small>※GASが自動生成する参照IDとは別</small>
                </div>
                <div class="form-group">
                    <label for="quoteDate">見積日<span class="required-mark">*</span></label>
                    <input type="date" id="quoteDate" name="quoteDate" required>
                </div>
            </div>

            <div class="form-group">
                <label for="validUntil">有効期限<span class="required-mark">*</span></label>
                <input type="date" id="validUntil" name="validUntil" required>
            </div>

            <div class="form-group">
                <label>項目詳細<span class="required-mark">*</span></label>
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th>品名</th>
                            <th>数量</th>
                            <th>単価(円)</th>
                            <th>小計(円)</th>
                            <th>削除</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                    </tbody>
                </table>
                <button type="button" class="add-item-btn" id="addItemBtn">＋ 項目を追加</button>
            </div>

            <div class="total-section">
                <div>小計: ¥<span id="subtotalAmount">0</span></div>
                <div>消費税 (10%): ¥<span id="taxAmount">0</span></div>
                <hr style="border-top: 1px solid #ccc;">
                <div><strong>合計金額: ¥<span id="totalAmount">0</span></strong></div>
                <input type="hidden" id="amount" name="amount" value="0">
            </div>

            <div class="form-group">
                <label for="remarks">備考</label>
                <textarea id="remarks" name="remarks" placeholder="備考事項があればこちらに記入してください。"></textarea>
            </div>

            <div id="errorMessage"></div>

            <button type="submit" id="submitButton">見積もりを送信</button>
        </form>
    </div>

    <div id="loadingOverlay">
        <p>送信中...</p>
    </div>

    <script>
        // 新しいGASウェブアプリURLを設定
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxdj86yCnlbMYCGkVQwIsJ6dLJvFBrGJzNTxq0YuQxUypFlKelenoQjHWCm-OH-ueM/exec"; 
        const LIFF_ID = "2007092175-ZRreRvez"; 
        const TAX_RATE = 10; // 消費税率を10%に固定

        // --- DOMContentLoaded: 初期化処理 ---
        document.addEventListener('DOMContentLoaded', function() {
            if (!GAS_URL || GAS_URL.indexOf("AKfy") === -1 ) {
                 handleError("GAS URLが正しく設定されていません。");
                 document.getElementById('submitButton').disabled = true;
                 return;
            }
            initializeLiff();
            setCurrentDate();
            setInitialDate();
            bindEventListeners();
            
            // 初期状態で8行の項目欄を追加
            for (let i = 0; i < 8; i++) {
                addItemRow();
            }
        });

        // --- 今日の日付を表示 ---
        function setCurrentDate() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            const dateString = today.toLocaleDateString('ja-JP', options);
            
            const todayElement = document.getElementById('todayDate');
            if (todayElement) {
                todayElement.textContent = dateString;
            }
            
            // hidden inputにも日付を設定
            const createdDateInput = document.getElementById('createdDateInput');
            if (createdDateInput) {
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                createdDateInput.value = `${year}-${month}-${day}`;
            }
        }

        // --- LIFF初期化 ---
        function initializeLiff() {
            liff.init({ liffId: LIFF_ID })
                .then(() => {
                    console.log("LIFF init succeeded.");
                })
                .catch((err) => {
                    console.error('LIFF Initialization failed.', err);
                    handleError('LIFFの初期化に失敗しました。画面を再読み込みしてください。');
                });
        }

        // --- 初期日付設定 ---
        function setInitialDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            
            // 見積日を設定
            const quoteDateInput = document.getElementById('quoteDate');
            if (quoteDateInput) {
                quoteDateInput.value = todayStr;
            }
            
            // 有効期限を1ヶ月後に設定
            const validUntil = document.getElementById('validUntil');
            if (validUntil) {
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                const validUntilStr = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}-${String(nextMonth.getDate()).padStart(2, '0')}`;
                validUntil.value = validUntilStr;
            }
        }

        // --- イベントリスナー設定 ---
        function bindEventListeners() {
            const addItemButton = document.getElementById('addItemBtn');
            const quoteForm = document.getElementById('quoteForm');
            const itemsTableBody = document.getElementById('itemsTableBody');

            if (addItemButton) {
                addItemButton.addEventListener('click', addItemRow);
            }
            if (quoteForm) {
                quoteForm.addEventListener('submit', handleFormSubmit);
            }

            // イベント委任：項目詳細テーブル内の入力や削除ボタンに対応
            if (itemsTableBody) {
                itemsTableBody.addEventListener('input', function(event) {
                    // 数量または単価の入力時に合計を再計算
                    if (event.target.classList.contains('item-quantity') || event.target.classList.contains('item-price')) {
                        calculateTotal();
                    }
                });
                itemsTableBody.addEventListener('click', function(event) {
                    // 削除ボタンがクリックされた場合
                    if (event.target.classList.contains('remove-item-btn')) {
                        removeItemRow(event.target);
                    }
                });
            }
        }

        // --- 項目行の追加 ---
        function addItemRow() {
            const tableBody = document.getElementById('itemsTableBody');
            if (!tableBody) return;

            const newRow = tableBody.insertRow();
            // Input types explicitly set for potentially better mobile keyboard behavior
            newRow.innerHTML = `
                <td><input type="text" class="item-name" placeholder="品名・作業内容" required></td>
                <td><input type="number" class="item-quantity" value="1" min="0" step="any" required inputmode="decimal"></td>
                <td><input type="number" class="item-price" value="0" min="0" step="any" required inputmode="decimal"></td>
                <td class="item-subtotal" style="text-align:right;">¥0</td>
                <td class="action-cell"><button type="button" class="remove-item-btn" aria-label="削除">×</button></td>
            `;
            // Calculate total after row is added to the DOM
             calculateTotal(); 
        }

        // --- 項目行の削除 ---
        function removeItemRow(button) {
            // Use closest to find the row, more robust
            const row = button.closest('tr'); 
            if (row) {
                row.remove();
                calculateTotal(); // 行を削除したら合計を再計算
            }
        }

        // --- 合計計算 ---
        function calculateTotal() {
            let subtotal = 0;
            const tableBody = document.getElementById('itemsTableBody');
            const subtotalAmountDisplay = document.getElementById('subtotalAmount');
            const taxAmountDisplay = document.getElementById('taxAmount');
            const totalAmountDisplay = document.getElementById('totalAmount');
            const amountInput = document.getElementById('amount'); // Hidden input for total

            // Check if all display elements exist
            if (!tableBody || !subtotalAmountDisplay || !taxAmountDisplay || !totalAmountDisplay || !amountInput) {
                console.error("合計計算に必要な要素が見つかりません。");
                return; 
            }

            const rows = tableBody.rows;
            for (let i = 0; i < rows.length; i++) {
                const quantityInput = rows[i].querySelector('.item-quantity');
                const priceInput = rows[i].querySelector('.item-price');
                const subtotalCell = rows[i].querySelector('.item-subtotal');

                if (!quantityInput || !priceInput || !subtotalCell) continue; 

                // Ensure values are treated as numbers, default to 0 if invalid
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const itemSubtotal = quantity * price;
                
                subtotalCell.textContent = `¥${itemSubtotal.toLocaleString()}`;
                subtotal += itemSubtotal;
            }

            // 固定税率を使用
            const tax = Math.floor(subtotal * (TAX_RATE / 100));
            const total = subtotal + tax;

            subtotalAmountDisplay.textContent = subtotal.toLocaleString();
            taxAmountDisplay.textContent = tax.toLocaleString();
            totalAmountDisplay.textContent = total.toLocaleString();
            amountInput.value = total; 
        }

        // --- フォーム送信処理 ---
        async function handleFormSubmit(event) {
            event.preventDefault(); 
            clearError(); 
            const form = document.getElementById('quoteForm');
            const submitButton = document.getElementById('submitButton');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if(!form || !submitButton || !loadingOverlay) return;

            // --- Validation ---
            if (!form.checkValidity()) {
                 handleError('必須項目が入力されていないか、入力形式が正しくありません。');
                 form.reportValidity();
                 return;
            }
            const itemsTableBody = document.getElementById('itemsTableBody');
            if (!itemsTableBody || itemsTableBody.rows.length === 0) {
                 handleError('項目詳細を少なくとも1つ入力してください。');
                 return;
            }
            const items = collectItemData();
            if (!items) { 
                 return; 
            }
            // --- Validation End ---

            submitButton.disabled = true;
            loadingOverlay.classList.add('show');

            try {
                const formData = new FormData(form);
                formData.append('itemsJson', JSON.stringify(items)); 
                // Ensure 'amount' uses the recently calculated value from the hidden input
                formData.set('amount', document.getElementById('amount').value); 

                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData,
                });

                // Check for network/server errors first
                if (!response.ok) {
                    throw new Error(`サーバー応答エラー: ${response.status} ${response.statusText}`);
                }
                
                // Try parsing JSON, handle potential errors
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    console.error("JSON解析エラー:", jsonError);
                    throw new Error("サーバーからの応答形式が正しくありません。");
                }

                if (result.success) {
                    console.log("送信成功:", result);
                    
                    // フォームを非表示にして完了メッセージを表示
                    const container = document.querySelector('.container');
                    
                    // 元のフォーム内容を保存
                    const originalContent = container.innerHTML;
                    
                    // 完了メッセージを表示
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="color: #06c755; font-size: 60px; margin: 20px 0;">✓</div>
                            <h1 style="color: #06c755; font-size: 24px; margin-bottom: 20px;">送信完了</h1>
                            <p style="font-size: 16px; line-height: 1.6; color: #333; margin-bottom: 20px;">お問い合わせありがとうございました。<br>内容を確認の上、担当者より連絡させていただきます。</p>
                            <p style="font-size: 16px; line-height: 1.6; color: #333; margin-bottom: 20px;">このページは閉じて大丈夫です。</p>
                            <button id="closeButton" style="background-color: #6c757d; color: white; border: none; border-radius: 4px; padding: 10px 20px; font-size: 16px; cursor: pointer; margin-right: 10px;">ウィンドウを閉じる</button>
                            <button id="backButton" style="background-color: #007bff; color: white; border: none; border-radius: 4px; padding: 10px 20px; font-size: 16px; cursor: pointer;">新しい見積もりを作成</button>
                        </div>
                    `;
                    
                    // 閉じるボタンの処理
                    document.getElementById('closeButton').addEventListener('click', function() {
                        if (liff.isInClient()) { 
                            liff.closeWindow(); 
                        } else { 
                            alert('このウィンドウを閉じてください。'); 
                        }
                    });
                    
                    // 戻るボタンの処理
                    document.getElementById('backButton').addEventListener('click', function() {
                        container.innerHTML = originalContent;
                        // 必要なイベントリスナーを再度バインド
                        setCurrentDate();
                        bindEventListeners();
                        // 8行の項目欄を追加
                        for (let i = 0; i < 8; i++) {
                            addItemRow();
                        }
                        setInitialDate();
                    });
                    
                    // LIFF内の場合は5秒後に自動的に閉じる
                    setTimeout(() => { 
                        if (liff.isInClient()) { 
                            liff.closeWindow(); 
                        } 
                    }, 5000);
                    
                } else {
                    console.error("送信失敗 (GAS):", result.error);
                    handleError(`送信に失敗しました: ${result.error || 'GASからエラーが返されました'}`);
                }

            } catch (error) {
                console.error("送信処理中のエラー:", error);
                handleError(`送信中にエラーが発生しました: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                loadingOverlay.classList.remove('show');
            }
        }

        // --- 項目データ収集 (バリデーション含む) ---
        function collectItemData() {
            const items = [];
            const rows = document.getElementById('itemsTableBody').rows;
            let isValid = true;
            for (let i = 0; i < rows.length; i++) {
                const nameInput = rows[i].querySelector('.item-name');
                const quantityInput = rows[i].querySelector('.item-quantity');
                const priceInput = rows[i].querySelector('.item-price');

                if (!nameInput || !quantityInput || !priceInput) {
                    console.error("項目行に必要な要素が見つかりません。行:", i);
                    isValid = false;
                    break; 
                }
                const name = nameInput.value.trim(); 
                const quantity = parseFloat(quantityInput.value);
                const price = parseFloat(priceInput.value);

                if (name === '' || isNaN(quantity) || quantity < 0 || isNaN(price) || price < 0) {
                     isValid = false;
                     rows[i].style.backgroundColor = '#ffdddd'; // Highlight the problematic row
                     break;
                } else {
                     rows[i].style.backgroundColor = ''; // Reset background color
                }
                items.push({ name: name, quantity: quantity, price: price });
            }

            if (!isValid) {
                handleError('項目詳細の入力内容を確認してください（空の品名、または0未満の数量/単価）。赤くハイライトされた行をご確認ください。');
                return null; 
            }
            // Reset background colors on success
             for (let i = 0; i < rows.length; i++) {
                 rows[i].style.backgroundColor = '';
             }
            return items;
        }

        // --- エラーメッセージ表示 ---
        function handleError(message) {
            const errorMessageDiv = document.getElementById('errorMessage');
            if (errorMessageDiv) {
                errorMessageDiv.textContent = message;
            }
             console.error("エラー表示:", message);
        }

        // --- エラーメッセージクリア ---
        function clearError() {
             const errorMessageDiv = document.getElementById('errorMessage');
            if (errorMessageDiv) {
                errorMessageDiv.textContent = '';
            }
        }
    </script>
</body>
</html>
