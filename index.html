<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> <title>見積もり作成フォーム</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* CSSは変更なしのため省略（前回のコードと同じ） */
        body { font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; margin: 0; padding: 16px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #06c755; margin-bottom: 25px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input[type="text"], input[type="date"], input[type="number"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; appearance: none; /* iOSでの見た目調整 */ }
        input[type="number"] { text-align: right; } /* 数値は右寄せに */
        textarea { height: 80px; resize: vertical; }
        button { background-color: #06c755; color: white; border: none; border-radius: 4px; padding: 12px 20px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; display: block; margin: 20px auto 0; width: 100%; max-width: 300px; }
        button:hover { background-color: #05a544; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #itemsTable { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; /* テーブルレイアウト固定 */ }
        #itemsTable th, #itemsTable td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; word-wrap: break-word; /* 長い文字の折り返し */ }
        #itemsTable th { background-color: #f2f2f2; font-weight: bold; }
        #itemsTable th:nth-child(1) { width: 35%; } /* 品名 */
        #itemsTable th:nth-child(2) { width: 15%; } /* 数量 */
        #itemsTable th:nth-child(3) { width: 20%; } /* 単価 */
        #itemsTable th:nth-child(4) { width: 20%; } /* 小計 */
        #itemsTable th:nth-child(5) { width: 10%; } /* 削除 */
        #itemsTable input[type="text"], #itemsTable input[type="number"] { width: 95%; padding: 6px; font-size: 14px; -webkit-appearance: none; appearance: none; }
        #itemsTable .item-subtotal { text-align: right; min-width: auto; /* 幅はthで指定 */ }
        #itemsTable .action-cell { width: auto; /* 幅はthで指定 */ text-align: center; }
        .remove-item-btn { background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 8px; font-size: 12px; cursor: pointer; }
        .add-item-btn { background-color: #007bff; color: white; border: none; border-radius: 4px; padding: 8px 15px; font-size: 14px; cursor: pointer; margin-top: 10px; }
        .total-section { margin-top: 20px; text-align: right; font-size: 16px; font-weight: bold; }
        .total-section div { margin-bottom: 5px; } /* 合計欄の行間調整 */
        .total-section span { display: inline-block; min-width: 100px; text-align: right; margin-left: 10px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.2em; z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        #loadingOverlay.show { visibility: visible; opacity: 1; }
        #errorMessage { color: #dc3545; margin-top: 15px; text-align: center; font-weight: bold; min-height: 1.2em; /* エラーメッセージ表示領域確保 */ }
        small { font-size: 0.8em; color: #6c757d; }
        .required-mark { color: red; margin-left: 2px; } /* 必須マーク */
    </style>
</head>
<body>
    <div class="container">
        <h1>見積もり作成</h1>
        <form id="quoteForm">
            <input type="hidden" name="formType" value="quote">

            <div class="form-group">
                <label for="customerName">顧客名<span class="required-mark">*</span></label>
                <input type="text" id="customerName" name="customerName" required>
            </div>

            <div class="form-group">
                <label for="subject">件名<span class="required-mark">*</span></label>
                <input type="text" id="subject" name="subject" required>
            </div>

            <div class="form-group">
                <label for="quoteNumber">見積番号 (任意)</label>
                <input type="text" id="quoteNumber" name="quoteNumber">
                <small>※GASが自動生成する参照IDとは別</small>
            </div>

            <div class="form-group">
                <label for="quoteDate">見積日<span class="required-mark">*</span></label>
                <input type="date" id="quoteDate" name="quoteDate" required>
            </div>

            <div class="form-group">
                <label for="validUntil">有効期限</label>
                <input type="date" id="validUntil" name="validUntil">
            </div>

             <div class="form-group">
                <label for="constructionSite">工事場所/納品場所<span class="required-mark">*</span></label>
                <input type="text" id="constructionSite" name="constructionSite" required>
            </div>

            <div class="form-group">
                <label for="paymentTerms">支払条件</label>
                <input type="text" id="paymentTerms" name="paymentTerms" placeholder="例: 納品後翌月末銀行振込">
            </div>

            <div class="form-group">
                <label>項目詳細<span class="required-mark">*</span></label>
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th>品名</th>
                            <th>数量</th>
                            <th>単価(円)</th>
                            <th>小計(円)</th>
                            <th>削除</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        </tbody>
                </table>
                <button type="button" class="add-item-btn" id="addItemBtn">＋ 項目を追加</button>
            </div>

             <div class="form-group">
                <label for="taxRate">消費税率 (%)</label>
                <input type="number" id="taxRate" name="taxRate" value="10" step="0.1"> </div>

            <div class="total-section">
                <div>小計: ¥<span id="subtotalAmount">0</span></div>
                <div>消費税 (<span id="taxRateDisplay">10</span>%): ¥<span id="taxAmount">0</span></div>
                <hr style="border-top: 1px solid #ccc;">
                <div><strong>合計金額: ¥<span id="totalAmount">0</span></strong></div>
                <input type="hidden" id="amount" name="amount" value="0">
            </div>

            <div class="form-group">
                <label for="remarks">備考</label>
                <textarea id="remarks" name="remarks"></textarea>
            </div>

            <div id="errorMessage"></div>

            <button type="submit" id="submitButton">見積もりを送信</button>
        </form>
    </div>

    <div id="loadingOverlay">
        <p>送信中...</p>
    </div>

    <script>
        // 新しいGASウェブアプリURLを設定
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxdj86yCnlbMYCGkVQwIsJ6dLJvFBrGJzNTxq0YuQxUypFlKelenoQjHWCm-OH-ueM/exec"; 
        const LIFF_ID = "2007092175-ZRreRvez"; 

        // --- DOMContentLoaded: 初期化処理 ---
        document.addEventListener('DOMContentLoaded', function() {
            if (!GAS_URL || GAS_URL.indexOf("AKfy") === -1 ) {
                 handleError("GAS URLが正しく設定されていません。");
                 document.getElementById('submitButton').disabled = true;
                 return;
            }
            initializeLiff();
            setInitialDate();
            bindEventListeners(); // イベントリスナーをまとめて設定
            addItemRow(); // 最初に1行追加
        });

        // --- LIFF初期化 ---
        function initializeLiff() {
            liff.init({ liffId: LIFF_ID })
                .then(() => console.log("LIFF init succeeded."))
                .catch((err) => {
                    console.error('LIFF Initialization failed.', err);
                    handleError('LIFFの初期化に失敗しました。画面を再読み込みしてください。');
                });
        }

        // --- 初期日付設定 ---
        function setInitialDate() {
            const today = new Date();
            const year = today.getFullYear(); // Use getFullYear()
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            const quoteDateInput = document.getElementById('quoteDate');
            if (quoteDateInput) {
                quoteDateInput.value = todayStr;
            }
        }

        // --- イベントリスナー設定 ---
        function bindEventListeners() {
            const addItemButton = document.getElementById('addItemBtn');
            const quoteForm = document.getElementById('quoteForm');
            const taxRateInput = document.getElementById('taxRate');
            const itemsTableBody = document.getElementById('itemsTableBody');

            if (addItemButton) {
                addItemButton.addEventListener('click', addItemRow);
            }
            if (quoteForm) {
                quoteForm.addEventListener('submit', handleFormSubmit);
            }
             if (taxRateInput) {
                 // 税率が変わったら合計再計算
                taxRateInput.addEventListener('input', calculateTotal);
            }
            // イベント委任：項目詳細テーブル内の入力や削除ボタンに対応
            if (itemsTableBody) {
                itemsTableBody.addEventListener('input', function(event) {
                    // 数量または単価の入力時に合計を再計算
                    if (event.target.classList.contains('item-quantity') || event.target.classList.contains('item-price')) {
                        calculateTotal();
                    }
                });
                itemsTableBody.addEventListener('click', function(event) {
                    // 削除ボタンがクリックされた場合
                    if (event.target.classList.contains('remove-item-btn')) {
                        removeItemRow(event.target);
                    }
                });
            }
        }

        // --- 項目行の追加 ---
        function addItemRow() {
            const tableBody = document.getElementById('itemsTableBody');
            if (!tableBody) return;

            const newRow = tableBody.insertRow();
            // Input types explicitly set for potentially better mobile keyboard behavior
            newRow.innerHTML = `
                <td><input type="text" class="item-name" placeholder="品名・作業内容" required></td>
                <td><input type="number" class="item-quantity" value="1" min="0" step="any" required inputmode="decimal"></td>
                <td><input type="number" class="item-price" value="0" min="0" step="any" required inputmode="decimal"></td>
                <td class="item-subtotal" style="text-align:right;">¥0</td>
                <td class="action-cell"><button type="button" class="remove-item-btn" aria-label="削除">×</button></td>
            `;
            // Calculate total after row is added to the DOM
             calculateTotal(); 
        }

        // --- 項目行の削除 ---
        function removeItemRow(button) {
            // Use closest to find the row, more robust
            const row = button.closest('tr'); 
            if (row) {
                row.remove();
                calculateTotal(); // 行を削除したら合計を再計算
            }
        }

        // --- 合計計算 ---
        function calculateTotal() {
            let subtotal = 0;
            const tableBody = document.getElementById('itemsTableBody');
            const taxRateInput = document.getElementById('taxRate');
            const taxRateDisplay = document.getElementById('taxRateDisplay');
            const subtotalAmountDisplay = document.getElementById('subtotalAmount');
            const taxAmountDisplay = document.getElementById('taxAmount');
            const totalAmountDisplay = document.getElementById('totalAmount');
            const amountInput = document.getElementById('amount'); // Hidden input for total

            // Check if all display elements exist
            if (!tableBody || !taxRateInput || !taxRateDisplay || !subtotalAmountDisplay || !taxAmountDisplay || !totalAmountDisplay || !amountInput) {
                console.error("合計計算に必要な要素が見つかりません。");
                return; 
            }

            const rows = tableBody.rows;
            for (let i = 0; i < rows.length; i++) {
                const quantityInput = rows[i].querySelector('.item-quantity');
                const priceInput = rows[i].querySelector('.item-price');
                const subtotalCell = rows[i].querySelector('.item-subtotal');

                if (!quantityInput || !priceInput || !subtotalCell) continue; 

                // Ensure values are treated as numbers, default to 0 if invalid
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const itemSubtotal = quantity * price;
                
                subtotalCell.textContent = `¥${itemSubtotal.toLocaleString()}`;
                subtotal += itemSubtotal;
            }

            const taxRate = parseFloat(taxRateInput.value) || 0;
            // Ensure tax calculation doesn't result in negative or unexpected values
            const tax = (taxRate >= 0 && subtotal >= 0) ? Math.floor(subtotal * (taxRate / 100)) : 0;
            const total = subtotal + tax;

            taxRateDisplay.textContent = taxRate.toLocaleString(); 
            subtotalAmountDisplay.textContent = subtotal.toLocaleString();
            taxAmountDisplay.textContent = tax.toLocaleString();
            totalAmountDisplay.textContent = total.toLocaleString();
            amountInput.value = total; 
        }

        // --- フォーム送信処理 ---
        async function handleFormSubmit(event) {
            event.preventDefault(); 
            clearError(); 
            const form = document.getElementById('quoteForm');
            const submitButton = document.getElementById('submitButton');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if(!form || !submitButton || !loadingOverlay) return;

            // --- Validation ---
            if (!form.checkValidity()) {
                 handleError('必須項目が入力されていないか、入力形式が正しくありません。');
                 form.reportValidity();
                 return;
            }
            const itemsTableBody = document.getElementById('itemsTableBody');
            if (!itemsTableBody || itemsTableBody.rows.length === 0) {
                 handleError('項目詳細を少なくとも1つ入力してください。');
                 return;
            }
            const items = collectItemData();
            if (!items) { 
                 return; 
            }
            // --- Validation End ---

            submitButton.disabled = true;
            loadingOverlay.classList.add('show');

            try {
                const formData = new FormData(form);
                formData.append('itemsJson', JSON.stringify(items)); 
                // Ensure 'amount' uses the recently calculated value from the hidden input
                formData.set('amount', document.getElementById('amount').value); 

                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData,
                });

                // Check for network/server errors first
                if (!response.ok) {
                    throw new Error(`サーバー応答エラー: ${response.status} ${response.statusText}`);
                }
                
                // Try parsing JSON, handle potential errors
                let result;
                 try {
                     result = await response.json();
                 } catch (jsonError) {
                     console.error("JSON解析エラー:", jsonError);
                     throw new Error("サーバーからの応答形式が正しくありません。");
                 }

                if (result.success) {
                    console.log("送信成功:", result);
                    window.location.href = 'thanks.html'; // Redirect to thanks.html
                } else {
                    console.error("送信失敗 (GAS):", result.error);
                    handleError(`送信に失敗しました: ${result.error || 'GASからエラーが返されました'}`);
                }

            } catch (error) {
                console.error("送信処理中のエラー:", error);
                handleError(`送信中にエラーが発生しました: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                loadingOverlay.classList.remove('show');
            }
        }

        // --- 項目データ収集 (バリデーション含む) ---
        function collectItemData() {
            const items = [];
            const rows = document.getElementById('itemsTableBody').rows;
            let isValid = true;
            for (let i = 0; i < rows.length; i++) {
                const nameInput = rows[i].querySelector('.item-name');
                const quantityInput = rows[i].querySelector('.item-quantity');
                const priceInput = rows[i].querySelector('.item-price');

                if (!nameInput || !quantityInput || !priceInput) {
                     // This case should ideally not happen if rows are added correctly
                    console.error("項目行に必要な要素が見つかりません。行:", i);
                    isValid = false;
                    break; 
                }
                const name = nameInput.value.trim(); 
                const quantity = parseFloat(quantityInput.value);
                const price = parseFloat(priceInput.value);

                if (name === '' || isNaN(quantity) || quantity < 0 || isNaN(price) || price < 0) {
                     isValid = false;
                     // Highlight the problematic row (optional)
                     rows[i].style.backgroundColor = '#ffdddd'; 
                     break;
                } else {
                     // Reset background color if previously highlighted (optional)
                     rows[i].style.backgroundColor = ''; 
                }
                items.push({ name: name, quantity: quantity, price: price });
            }

            if (!isValid) {
                handleError('項目詳細の入力内容を確認してください（空の品名、または0未満の数量/単価）。');
                return null; 
            }
            // Reset background colors on success (optional)
             for (let i = 0; i < rows.length; i++) {
                 rows[i].style.backgroundColor = '';
             }
            return items;
        }

        // --- エラーメッセージ表示 ---
        function handleError(message) {
            const errorMessageDiv = document.getElementById('errorMessage');
            if (errorMessageDiv) {
                errorMessageDiv.textContent = message;
            }
             console.error("エラー表示:", message);
        }

         // --- エラーメッセージクリア ---
        function clearError() {
             const errorMessageDiv = document.getElementById('errorMessage');
            if (errorMessageDiv) {
                errorMessageDiv.textContent = '';
            }
        }

    </script>
</body>
</html>
