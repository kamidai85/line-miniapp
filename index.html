// 項目行の追加
function addItemRow(formPrefix) {
  try {
    const container = document.getElementById(`${formPrefix}-items-container`);
    const rowIndex = Date.now(); // 一意のIDを生成

    const row = document.createElement('div');
    row.className = 'item-row';
    row.setAttribute('data-index', rowIndex);
    row.innerHTML = `
      <div>
        <label class="required" for="${formPrefix}-item-name-${rowIndex}">項目名</label>
        <input type="text" id="${formPrefix}-item-name-${rowIndex}" class="item-name" required>
      </div>
      <div>
        <label class="required" for="${formPrefix}-item-quantity-${rowIndex}">数量</label>
        <input type="number" id="${formPrefix}-item-quantity-${rowIndex}" class="item-quantity" min="1" value="1" required>
      </div>
      <div>
        <label class="required" for="${formPrefix}-item-unit-${rowIndex}">単位</label>
        <input type="text" id="${formPrefix}-item-unit-${rowIndex}" class="item-unit" value="個" required>
      </div>
      <div>
        <label class="required" for="${formPrefix}-item-price-${rowIndex}">単価</label>
        <input type="number" id="${formPrefix}-item-price-${rowIndex}" class="item-price" min="0" value="0" required>
      </div>
      <div>
        <label for="${formPrefix}-item-subtotal-${rowIndex}">小計</label>
        <input type="text" id="${formPrefix}-item-subtotal-${rowIndex}" class="item-subtotal" value="0円" readonly>
      </div>
      <button type="button" class="remove-item">削除</button>
    `;

    container.appendChild(row);

    // 入力イベントリスナー追加
    ['quantity', 'price'].forEach(field => {
      row.querySelector(`.item-${field}`).addEventListener('input', () => {
        calculateItemSubtotal(formPrefix, rowIndex);
        updateTotals(formPrefix);
      });
    });

    // 削除ボタンのイベントリスナー
    row.querySelector('.remove-item').addEventListener('click', () => {
      if (container.children.length > 1) {
        row.remove();
        updateTotals(formPrefix);
      } else {
        alert('少なくとも1つの項目が必要です');
      }
    });

    calculateItemSubtotal(formPrefix, rowIndex);
    updateTotals(formPrefix);

  } catch (err) {
    console.error('項目追加エラー:', err);
  }
}

// 項目の小計計算
function calculateItemSubtotal(formPrefix, rowIndex) {
  const quantity = parseFloat(document.getElementById(`${formPrefix}-item-quantity-${rowIndex}`).value) || 0;
  const price = parseFloat(document.getElementById(`${formPrefix}-item-price-${rowIndex}`).value) || 0;
  const subtotal = quantity * price;
  document.getElementById(`${formPrefix}-item-subtotal-${rowIndex}`).value = formatCurrency(subtotal);
}

// 合計計算
function updateTotals(formPrefix) {
  const container = document.getElementById(`${formPrefix}-items-container`);
  let subtotal = 0;

  Array.from(container.children).forEach(row => {
    const rowIndex = row.getAttribute('data-index');
    const quantity = parseFloat(document.getElementById(`${formPrefix}-item-quantity-${rowIndex}`).value) || 0;
    const price = parseFloat(document.getElementById(`${formPrefix}-item-price-${rowIndex}`).value) || 0;
    subtotal += quantity * price;
  });

  const taxRate = parseFloat(document.getElementById(`${formPrefix}-tax-rate`).value) || 0;
  const taxAmount = subtotal * (taxRate / 100);
  const total = subtotal + taxAmount;

  document.getElementById(`${formPrefix}-subtotal`).textContent = formatCurrency(subtotal);
  document.getElementById(`${formPrefix}-tax-amount`).textContent = formatCurrency(taxAmount);
  document.getElementById(`${formPrefix}-total-amount`).textContent = formatCurrency(total);

  document.getElementById(`${formPrefix}-amount`).value = total;
}

// 通貨フォーマット
function formatCurrency(amount) {
  return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(amount);
}
